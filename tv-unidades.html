<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TV - USF Aero Rancho IV</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { background: #002b5c; color: white; font-family: sans-serif; text-align: center; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        .topo { background: #001a38; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid #ffcc00; }
        .unidade-nome { font-size: 1.8rem; font-weight: bold; text-align: left; }
        .relogio { font-size: 2.5rem; color: #ffcc00; }
        .conteudo-principal { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; position: relative; }
        #area-chamada { display: none; }
        .paciente { font-size: 8rem; font-weight: bold; color: #ffcc00; text-transform: uppercase; padding: 0 20px; line-height: 1.1; text-shadow: 4px 4px 10px rgba(0,0,0,0.5); }
        .sala { font-size: 5rem; background: white; color: #002b5c; padding: 10px 60px; border-radius: 20px; display: inline-block; margin-top: 25px; font-weight: bold; border: 4px solid #ffcc00; }
        #painel-informativo { display: block; padding: 20px; }
        .card-info { background: white; color: #333; border-radius: 25px; padding: 45px; max-width: 85%; margin: 0 auto; border-left: 25px solid #007bff; transition: all 0.5s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #titulo-info { font-size: 2rem; color: #666; margin: 0; text-transform: uppercase; }
        #texto-info { font-size: 4rem; margin: 25px 0; font-weight: bold; line-height: 1.2; }
        .barra-progresso { height: 10px; background: #eee; border-radius: 5px; margin-top: 20px; overflow: hidden; }
        #progresso-fill { height: 100%; width: 0%; background: #007bff; }
        @keyframes flash { 0% { background-color: #002b5c; } 50% { background-color: #ffcc00; } 100% { background-color: #002b5c; } }
        .piscar-alerta { animation: flash 0.8s ease-in-out 5; }
        .historico-tv { background: rgba(0,0,0,0.3); padding: 15px; display: flex; justify-content: center; gap: 40px; }
        .hist-item-tv { border-left: 4px solid #ffcc00; padding-left: 15px; text-align: left; }
        .marquee { background: #ffcc00; color: #002b5c; padding: 10px 0; font-size: 1.6rem; font-weight: bold; }
        #aviso-inicial { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    </style>
</head>
<body id="corpo-tv">
    <div id="aviso-inicial" onclick="this.style.display='none'">
        <h1 style="color: #ffcc00;">SISTEMA PRONTO</h1>
        <p>Clique em qualquer lugar para ativar o som e a voz.</p>
    </div>

    <div class="topo">
        <div class="unidade-nome">USF AERO RANCHO IV<br><span style="font-size: 1.1rem; opacity: 0.8;">Dr. Nelson Tokuei Simabukuro</span></div>
        <div id="relogio" class="relogio">00:00:00</div>
    </div>

    <div class="conteudo-principal">
        <div id="area-chamada">
            <div id="txtPaciente" class="paciente">--</div>
            <div id="txtSala" class="sala">AGUARDE</div>
        </div>

        <div id="painel-informativo">
            <div class="card-info" id="card-cor">
                <h1 id="titulo-info">INFORMATIVO</h1>
                <div id="texto-info">Carregando avisos...</div>
                <div class="barra-progresso">
                    <div id="progresso-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="painel-historico" class="historico-tv"></div>
    <div class="marquee"><marquee>Bem-vindo à USF Aero Rancho IV • Respeite o fluxo de atendimento • Mantenha o silêncio para não perder sua chamada.</marquee></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-LPsGPEGcjMRPcEReNDQdgFWE5iE7Bh0",
            authDomain: "usf-aero-rancho-b6d85.firebaseapp.com",
            projectId: "usf-aero-rancho-b6d85",
            databaseURL: "https://usf-aero-rancho-b6d85-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const somCampainha = new Audio('https://assets.mixkit.co/active_storage/sfx/2861/2861-preview.mp3');
        
        let filaDeEspera = [];
        let processandoChamada = false;
        let listaAvisos = [];
        let indiceAviso = 0;
        let intervaloCarrossel;
        let histTv = [];

        database.ref('fila_chamadas').on('child_added', (snap) => {
            const chamada = snap.val();
            filaDeEspera.push(chamada);
            database.ref('fila_chamadas/' + snap.key).remove();
            if (!processandoChamada) iniciarProcessamentoFila();
        });

        async function iniciarProcessamentoFila() {
            if (filaDeEspera.length === 0) {
                processandoChamada = false;
                voltarParaCarrossel();
                return;
            }

            processandoChamada = true;
            pararCarrossel();

            const atual = filaDeEspera.shift();
            document.getElementById('area-chamada').style.display = 'block';
            document.getElementById('painel-informativo').style.display = 'none';
            document.getElementById('txtPaciente').innerText = atual.msg;
            document.getElementById('txtSala').innerText = atual.local;
            
            document.body.classList.remove('piscar-alerta');
            void document.body.offsetWidth;
            document.body.classList.add('piscar-alerta');
            
            somCampainha.play().catch(e => console.log("Áudio aguardando clique"));

            atualizarHistoricoTV(atual.msg, atual.local);

            // Chamada de voz com "Atenção"
            await falarTexto(atual.msg, atual.local);

            setTimeout(iniciarProcessamentoFila, 4000);
        }

        function falarTexto(nome, local) {
            return new Promise((resolve) => {
                try {
                    let localLower = local.toLowerCase();
                    // Concordância de gênero para o local
                    let prep = (localLower.includes("recepção") || localLower.includes("sala") || localLower.includes("triagem") || localLower.includes("mesa")) ? "à" : "ao";
                    
                    // Converte sigla para fala por extenso
                    let nomeParaVoz = nome.replace("PREF.", "Preferencial");
                    
                    let texto;
                    if (nome.toUpperCase().includes("SENHA")) {
                        // Ex: "Atenção. Senha Normal zero um. Comparecer à Recepção zero um."
                        texto = `Atenção. ${nomeParaVoz}. Comparecer ${prep} ${local}`;
                    } else {
                        // Ex: "Atenção. Paciente João da Silva. Dirija-se ao Consultório zero dois."
                        texto = `Atenção. Paciente ${nomeParaVoz}. Dirija-se ${prep} ${local}`;
                    }
                    
                    const fala = new SpeechSynthesisUtterance(texto);
                    fala.lang = 'pt-BR';
                    fala.rate = 0.9;
                    
                    fala.onend = () => resolve();
                    fala.onerror = () => resolve();
                    
                    window.speechSynthesis.speak(fala);
                    
                    setTimeout(() => resolve(), 10000);
                } catch(e) {
                    resolve();
                }
            });
        }

        database.ref('avisos_unidade').on('value', snap => {
            listaAvisos = [];
            snap.forEach(child => { listaAvisos.push(child.val()); });
            if (!processandoChamada) iniciarCarrossel();
        });

        function iniciarCarrossel() {
            pararCarrossel();
            if (listaAvisos.length === 0) {
                document.getElementById('texto-info').innerText = "USF AERO RANCHO IV";
                return;
            }
            rodarFrase();
            intervaloCarrossel = setInterval(rodarFrase, 12000);
        }

        function rodarFrase() {
            if (processandoChamada) return;
            const aviso = listaAvisos[indiceAviso];
            if(!aviso) return;
            const card = document.getElementById('card-cor');
            const txt = document.getElementById('texto-info');
            const fill = document.getElementById('progresso-fill');
            fill.style.transition = 'none';
            fill.style.width = '0%';
            fill.style.backgroundColor = aviso.cor;
            card.style.borderLeftColor = aviso.cor;
            txt.innerText = aviso.msg;
            setTimeout(() => {
                fill.style.transition = 'width 11.5s linear';
                fill.style.width = '100%';
            }, 100);
            indiceAviso = (indiceAviso + 1) % listaAvisos.length;
        }

        function pararCarrossel() { clearInterval(intervaloCarrossel); }

        function voltarParaCarrossel() {
            document.getElementById('area-chamada').style.display = 'none';
            document.getElementById('painel-informativo').style.display = 'block';
            iniciarCarrossel();
        }

        function atualizarHistoricoTV(msg, local) {
            histTv.unshift({msg, local});
            if(histTv.length > 4) histTv.pop();
            const painel = document.getElementById('painel-historico');
            painel.innerHTML = "";
            histTv.forEach(h => {
                painel.innerHTML += `<div class="hist-item-tv"><b>${h.msg}</b><br><span>${h.local}</span></div>`;
            });
        }

        setInterval(() => { 
            document.getElementById('relogio').innerText = new Date().toLocaleTimeString('pt-BR'); 
        }, 1000);
    </script>
</body>
</html>