<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TV - USF Aero Rancho IV</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { background: #002b5c; color: white; font-family: sans-serif; text-align: center; height: 100vh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        .topo { background: #001a38; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid #ffcc00; }
        .unidade-nome { font-size: 1.8rem; font-weight: bold; text-align: left; }
        .relogio { font-size: 2.5rem; color: #ffcc00; }
        .conteudo-principal { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; position: relative; }
        #area-chamada { display: none; }
        .paciente { font-size: 8rem; font-weight: bold; color: #ffcc00; text-transform: uppercase; }
        .sala { font-size: 5rem; background: white; color: #002b5c; padding: 10px 60px; border-radius: 20px; display: inline-block; margin-top: 25px; font-weight: bold; }
        #painel-informativo { display: block; padding: 20px; }
        .card-info { background: white; color: #333; border-radius: 25px; padding: 45px; max-width: 85%; margin: 0 auto; border-left: 25px solid #007bff; }
        #texto-info { font-size: 4rem; font-weight: bold; }
        .barra-progresso { height: 10px; background: #eee; border-radius: 5px; margin-top: 20px; overflow: hidden; }
        #progresso-fill { height: 100%; width: 0%; background: #007bff; }
        @keyframes flash { 0%, 100% { background-color: #002b5c; } 50% { background-color: #ffcc00; } }
        .piscar-alerta { animation: flash 0.8s ease-in-out 5; }
        .historico-tv { background: rgba(0,0,0,0.3); padding: 15px; display: flex; justify-content: center; gap: 40px; }
    </style>
</head>
<body id="corpo-tv">
    <div id="aviso-inicial" onclick="this.style.display='none'" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; cursor:pointer;">
        <h1 style="color:#ffcc00;">CLIQUE PARA ATIVAR O SOM</h1>
    </div>

    <div class="topo">
        <div class="unidade-nome">USF AERO RANCHO IV</div>
        <div id="relogio" class="relogio">00:00:00</div>
    </div>

    <div class="conteudo-principal">
        <div id="area-chamada">
            <div id="txtPaciente" class="paciente">--</div>
            <div id="txtSala" class="sala">AGUARDE</div>
        </div>
        <div id="painel-informativo">
            <div class="card-info" id="card-cor">
                <div id="texto-info">USF Aero Rancho IV</div>
                <div class="barra-progresso"><div id="progresso-fill"></div></div>
            </div>
        </div>
    </div>

    <div id="painel-historico" class="historico-tv"></div>

    <script>
        // TRAVA DE LOGIN
        if (sessionStorage.getItem("logado_usf") !== "true") { window.location.href = "index.html"; }

        const firebaseConfig = {
            apiKey: "AIzaSyB-LPsGPEGcjMRPcEReNDQdgFWE5iE7Bh0",
            authDomain: "usf-aero-rancho-b6d85.firebaseapp.com",
            projectId: "usf-aero-rancho-b6d85",
            databaseURL: "https://usf-aero-rancho-b6d85-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const somCampainha = new Audio('https://assets.mixkit.co/active_storage/sfx/2861/2861-preview.mp3');
        
        let filaDeEspera = [], processandoChamada = false, listaAvisos = [], indiceAviso = 0, intervaloCarrossel, histTv = [];

        database.ref('fila_chamadas').on('child_added', (snap) => {
            filaDeEspera.push(snap.val());
            database.ref('fila_chamadas/' + snap.key).remove();
            if (!processandoChamada) processarFila();
        });

        async function processarFila() {
            if (filaDeEspera.length === 0) { processandoChamada = false; voltarCarrossel(); return; }
            processandoChamada = true;
            const atual = filaDeEspera.shift();
            document.getElementById('area-chamada').style.display = 'block';
            document.getElementById('painel-informativo').style.display = 'none';
            document.getElementById('txtPaciente').innerText = atual.msg;
            document.getElementById('txtSala').innerText = atual.local;
            document.body.classList.add('piscar-alerta');
            somCampainha.play();
            atualizarHistoricoTV(atual.msg, atual.local);
            await falar(atual.msg, atual.local);
            setTimeout(processarFila, 4000);
        }

        function falar(n, l) {
            return new Promise(res => {
                const f = new SpeechSynthesisUtterance(`Paciente ${n}, comparecer ao ${l}`);
                f.lang = 'pt-BR'; f.onend = res;
                window.speechSynthesis.speak(f);
            });
        }

        database.ref('avisos_unidade').on('value', snap => {
            listaAvisos = []; snap.forEach(c => listaAvisos.push(c.val()));
            if (!processandoChamada) iniciarCarrossel();
        });

        function iniciarCarrossel() {
            clearInterval(intervaloCarrossel);
            rodarFrase();
            intervaloCarrossel = setInterval(rodarFrase, 12000);
        }

        function rodarFrase() {
            if (processandoChamada || listaAvisos.length === 0) return;
            const aviso = listaAvisos[indiceAviso];
            document.getElementById('texto-info').innerText = aviso.msg;
            document.getElementById('card-cor').style.borderLeftColor = aviso.cor;
            const fill = document.getElementById('progresso-fill');
            fill.style.transition = 'none'; fill.style.width = '0%';
            setTimeout(() => { fill.style.transition = 'width 11.5s linear'; fill.style.width = '100%'; }, 100);
            indiceAviso = (indiceAviso + 1) % listaAvisos.length;
        }

        function voltarCarrossel() {
            document.getElementById('area-chamada').style.display = 'none';
            document.getElementById('painel-informativo').style.display = 'block';
            document.body.classList.remove('piscar-alerta');
            iniciarCarrossel();
        }

        function atualizarHistoricoTV(m, l) {
            histTv.unshift({m, l}); if(histTv.length > 4) histTv.pop();
            const p = document.getElementById('painel-historico'); p.innerHTML = "";
            histTv.forEach(h => p.innerHTML += `<div><b>${h.m}</b> - ${h.l}</div>`);
        }

        setInterval(() => document.getElementById('relogio').innerText = new Date().toLocaleTimeString(), 1000);
    </script>
</body>
</html>